<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot Gob.sv</title>
  </head>

  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <df-messenger
    project-id="chatobot-dialogflow"
    agent-id="1de84d28-4cbe-477f-aaac-9352973ae576"
    language-code="es"
    max-query-length="-1"
  >
    <df-messenger-chat-bubble
      chat-title="Innova Chat"
    ></df-messenger-chat-bubble>
  </df-messenger>

  <style>
    df-messenger {
      z-index: 999;
      position: fixed;
      --df-messenger-font-color: #000;
      --df-messenger-font-family: Google Sans;
      --df-messenger-chat-background: #f3f6fc;
      --df-messenger-message-user-background: #d3e3fd;
      --df-messenger-message-bot-background: #fff;
      --df-messenger-chat-window-width: 600px;
      bottom: 16px;
      right: 16px;
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const dfMessenger = document.querySelector("df-messenger");
      let warningTimeout, closeTimeout; // Variables para los temporizadores

      // FunciÃ³n para reiniciar los temporizadores
      function resetTimers() {
        clearTimeout(warningTimeout);
        clearTimeout(closeTimeout);

        // Configura el temporizador de advertencia
        warningTimeout = setTimeout(() => {
          dfMessenger.renderCustomText(
            "Su sesiÃ³n estÃ¡ a punto de finalizar. Si necesita mÃ¡s asistencia, no dude en volver a contactarnos. Â¡Gracias por su tiempo! ðŸ¤–âœ¨",
            true
          );

          // Configura el temporizador para cerrar la sesiÃ³n
          closeTimeout = setTimeout(() => {
            dfMessenger.renderCustomText(
              "La sesiÃ³n ha finalizado. Gracias por su tiempo. Si necesita mÃ¡s asistencia, estaremos encantados de ayudarle en una nueva sesiÃ³n.",
              true
            );

            // Limpieza de la sesiÃ³n y cierre del chat
        
            const dfMessengerBubble = document.querySelector(
              "df-messenger-chat-bubble"
            );
            dfMessengerBubble.closeChat();
            dfMessenger.clearStorage();
            dfMessenger.clearAuthentication();
            dfMessenger.startNewSession({ retainHistory: true });
            sessionStorage.removeItem("df-messenger-sessionID");
          }, 60000);  // Muestra la advertencia tras 1 minuto de inactividad
        }, 60000); // Muestra la advertencia tras 1 minuto de inactividad
      }

      // Evento para manejar la apertura del chat
      window.addEventListener("df-chat-open-changed", (event) => {
        if (event.detail.isOpen) {
          const sessionId = sessionStorage.getItem("df-messenger-messages");
          
          if (!sessionId) {
            console.log("Chat abierto");
            dfMessenger.renderCustomText(
              "Hola, bienvenido a Gob.sv. Estoy aquÃ­ para ayudarte con trÃ¡mites, servicios e inquietudes sobre el Gobierno de El Salvador. ðŸ¤–âœ¨",
              true
            );
            dfMessenger.renderCustomText(
              "Por favor, selecciona una de estas opciones para continuar: Simple Sv, Identidad Digital o Instituciones.",
              true
            );
            dfMessenger.sendRequest("query", "Hola");

            sessionStorage.setItem("df-messenger-messages", "true"); // Evita reenvÃ­o
          }
        }
      });

      // Evento para reiniciar temporizadores cuando se recibe una respuesta
      window.addEventListener("df-response-received", (event) => {

        resetTimers(); // Reinicia los temporizadores con cada mensaje recibido
      });
    });
  </script>

  <body></body>
</html>
